function LogstatsQuery(t,e){this.url=t,this.projectToken=e}function LogstatsDataConverter(t,e,a){this.data=t,this.interval=e,this.timeframe=a}function LogstatsGraphDrawer(t,e){this.selector=t,this.currentShowedData=[],this.options="undefined"!=typeof e?e:[],this.flotLineOptions=this.getFlotLineOptions(),this.options.enablePointHover&&this.enableFlotHover(),this.options.enableSelectionZooming&&this.enableSelectionZooming()}$(document).ready(function(){function t(t,e){var a=t.format("DD MMMM YYYY, HH:mm:ss");a+=" - "+e.format("DD MMMM YYYY, HH:mm:ss"),$("div#daterange label").html(a)}function e(t){var e=moment().tz(a).utcOffset()-t.utcOffset();return t.unix()-60*e}var a=$("#data-holder").attr("data-timezone"),r=Date.now();$(".daterange input[name=from]").val(moment.tz(r,a).subtract(1,"hour").unix()),$(".daterange input[name=to]").val(moment.tz(r,a).unix()),$("div#daterange").daterangepicker({timePicker:!0,timePicker24Hour:!0,startDate:moment.tz(r,a).subtract(1,"hour"),endDate:moment.tz(r,a),opens:"left",ranges:{Today:[moment.tz(r,a).startOf("day"),moment.tz(r,a)],Yesterday:[moment.tz(r,a).subtract(1,"days").startOf("day"),moment.tz(r,a).subtract(1,"days").endOf("day")],"Last 20 Minutes":[moment.tz(r,a).subtract(20,"minutes"),moment.tz(r,a)],"Last Hour":[moment.tz(r,a).subtract(1,"hours"),moment.tz(r,a)],"Last 24 Hours":[moment.tz(r,a).subtract(24,"hours"),moment.tz(r,a)],"Last 7 Days":[moment.tz(r,a).subtract(7,"days"),moment.tz(r,a)],"Last 14 Days":[moment.tz(r,a).subtract(14,"days"),moment.tz(r,a)],"Last 30 Days":[moment.tz(r,a).subtract(30,"days"),moment.tz(r,a)]}},function(r,o,n){"Custom Range"==n?($("input[name=from]").val(e(r)),$("input[name=to]").val(e(o)),t(r,o)):($("input[name=from]").val(r.unix()),$("input[name=to]").val(o.unix()),t(r.tz(a),o.tz(a)))}),t(moment().tz(a).subtract(1,"hour"),moment().tz(a)),$(".nav-tabs li").click(function(){$(".nav-tabs li").removeClass("active"),$(this).addClass("active"),$(".tab-div").hide();var t=$(this).attr("data-id");$("#"+t).show()}),$(".submitable-link").click(function(){var t=$(this).attr("target-form-id");t?$("#"+t).submit():$(this).closest("form").submit()})}),timezoneJS.timezone.zoneFileBasePath="public/libraries/flot/tz",timezoneJS.timezone.defaultZoneFile=[],timezoneJS.timezone.init({async:!1}),$(document).ready(function(){function t(){a(),$.ajax({type:"GET",url:$("form#get-records").attr("action"),data:$("form#get-records").serialize(),success:function(t){0==t.count?$(".log-records").html("No records found"):$(".log-records").html(t.html),s=t.count,e(),console.log(t.graphData),t.graphData.data&&t.graphData.data.length>0?($(".log-graph").show(),n.draw(t.graphData.data,t.graphData.timeframe)):$(".log-graph").hide(),r()}})}function e(){var t=Math.ceil(s/l);$(".page-numbers ul").html("");for(var e=1;t>=e;e++){var a="";e==i&&(a="active"),$(".page-numbers ul").append('<li class="'+a+'" data-page="'+e+'"><a href="">'+e+"</a></li>")}}function a(){$("#loader").show()}function r(){$("#loader").hide()}function o(){var t=$("#example-filter-row").html();$(".filters").append('<div id="'+p+'">'+t+"</div>");var e=$("div#"+p);$(".property-name",e).attr("name","filters["+p+"][property-name]"),$(".property-type",e).attr("name","filters["+p+"][property-type]"),$(".comparison",e).attr("name","filters["+p+"][comparison-type]"),$(".value",e).attr("name","filters["+p+"][property-value]"),$(".remove-filter-row",e).attr("data-id",p),$('select[name="filters['+p+'][comparison-type]"]').chained('select[name="filters['+p+'][property-type]"]'),p++}if($(".log").size()>0){var n=new LogstatsGraphDrawer(".log-graph-area",{enablePointHover:!0,enableLineManipulation:!1,enableSelectionZooming:!1,timezone:$("#data-holder").attr("data-timezone")}),i=1,s=0,l=100,p=1;$("form#get-records").submit(function(e){$("input[name='page']").val("1"),t(),e.preventDefault()}),$(".page-numbers").on("click","li a",function(e){return i=$(this).parent().attr("data-page"),$(".page-numbers li").removeClass("active"),$(this).parent().addClass("active"),$('input[name="page"]').val(i),t(),window.scrollTo(0,0),e.preventDefault(),!1}),$(".add-filter").click(function(){$(".down-control").show()}),$("#add-filter-row").click(o),$(".filters").on("click",".remove-filter-row",function(){$("div#"+$(this).attr("data-id")).remove()}),$("div.log")&&(o(),t()),$("#export-csv").click(function(t){return window.location.href=$(this).attr("data-export-csv-url")+"?"+$("form#get-records").serialize(),!1})}}),$(document).ready(function(){function t(t){$.ajax({type:"GET",url:$(".segmentation").attr("data-property-names-url"),data:{"message-id":t},success:function(t){$(".property-options").html(""),$(".property-options").append("<option>&nbsp;</option>"),$.each(t,function(t,e){$(".property-options").append('<option value="'+e+'">'+e+"</option>")})}})}function e(){var t=$("#example-filter-row").html();$(".filters").append('<div id="'+p+'">'+t+"</div>");var e=$("div#"+p);$(".property-name",e).select2({placeholder:"Property name"}),$(".property-name",e).attr("name","filters["+p+"][propertyName]"),$(".comparison",e).attr("name","filters["+p+"][comparisonType]"),$(".value",e).attr("name","filters["+p+"][propertyValue]"),$(".remove-filter-row",e).attr("data-id",p),p++}function a(){$("#loader").show()}function r(){$("#loader").hide()}if($(".segmentation").size()>0){var o=new LogstatsGraphDrawer(".graph-area",{enablePointHover:!0,enableLineManipulation:!0,enableSelectionZooming:!0,timezone:$("#data-holder").attr("data-timezone")}),n=$("input[name='query-url']").val(),i=$("input[name='project-token']").val(),s=30,l=100,p=0;$("#query-form").submit(function(t){$("#export-image").hide(),a();var e=$(this).serializeObject();if($("select#event").val()){var s=$("select#event").val().split(",");e.event=s[1]}"undefined"!=typeof e.filters&&(e.filters=$.grep(e.filters,function(t){return"undefined"!=typeof t})),"None"==e.interval&&delete e.interval;var l=new LogstatsQuery(n,i);l.get(e,function(t){o.draw(t.data,t.timeframe),o.isExportable()&&$("#export-image").show(),r()},function(t){var e="undefined"!=typeof t.responseJSON?t.responseJSON:["Error while retrieving data"];o.displayErrors(e),r()}),t.preventDefault()}),$("#export-image").click(function(){$(".graph").css("background-color","#fff"),html2canvas($(".graph"),{onrendered:function(t){$(".graph").css("background","none"),console.log(t);var e=t.toDataURL("image/png").replace("image/png","image/octet-stream");window.location.href=e}})}),$("select#event").select2({ajax:{url:$("select#event").attr("data-url"),dataType:"json",delay:250,data:function(t){return{"message-search":t.term,page:t.page,"page-count":s,"project-id":$('input[name="project-id"]').val(),level:$('select[name="level"]').val()}},processResults:function(t,e){return e.page=e.page||1,{results:$.map(t.items,function(t,e){var a=t;return a.length>l&&(a=a.substring(0,l)+"..."),{text:a,slug:a,id:e+","+t}}),pagination:{more:30*e.page<t.total_count}}},cache:!0},escapeMarkup:function(t){return t},minimumInputLength:0,placeholder:"Choose event..."}),$(".group-by select").select2({placeholder:"Property name",allowClear:!0}),$(".target-property select").select2({placeholder:"Property name"}),$("select#event").change(function(){var e=$("select#event").val().split(",");$("select[name='groupBy']").select2("val",""),$("select[name='targetProperty']").select2("val",""),t(e[0])}),$(".aggregation select").change(function(){"count"==$(this).val()?$(".target-property select").attr("disabled","disabled"):$(".target-property select").removeAttr("disabled")}),$(".add-filter").click(function(){e(),$(".down-control").show()}),$("#add-filter-row").click(e),$(".filters").on("click",".remove-filter-row",function(){$("div#"+$(this).attr("data-id")).remove()})}}),LogstatsQuery.prototype.get=function(t,e,a){$.ajax({type:"GET",url:this.url,data:{query:t,projectToken:this.projectToken},success:e,error:a})},LogstatsDataConverter.prototype.getMoreLinesAssociativeWithZeros=function(){var t=this.getEmptyGroupAssociativeData(),e=this.getGroupAssoc(t);return e},LogstatsDataConverter.prototype.getOneLineAssociativeWithZeros=function(){var t=this.getEmptyDateAssociativeData();return this.getAssoc(t)},LogstatsDataConverter.prototype.getAllGroupByNames=function(){var t=[];for(i=0;i<this.data.length;i++)-1==t.indexOf(this.data[i].group)&&t.push(this.data[i].group);return t},LogstatsDataConverter.prototype.getEmptyGroupAssociativeData=function(){for(var t=this.getAllGroupByNames(),e={},a=0;a<t.length;a++){var r=this.getEmptyDateAssociativeData();e[t[a]]=r}return e},LogstatsDataConverter.prototype.getEmptyDateAssociativeData=function(){for(var t=this.getStartDate(),e=this.getEndDate(),a=t,r={};a.isBefore(e);)this.initializeDateDate(r,a),r[a.year()][a.month()][a.date()][a.hour()][a.minute()]=0,this.incrementDate(a);return r},LogstatsDataConverter.prototype.getStartDate=function(){var t;if("undefined"!=typeof this.timeframe)t=this.roundDateDown(moment(this.timeframe.from,"X").tz("GMT"));else{var e=this.data[0];t=moment.tz({year:e.year,month:e.month-1,day:e.day,hour:e.hour,minute:e.minute},"GMT")}return t},LogstatsDataConverter.prototype.roundDateDown=function(t){return t.second(0),"minutely"==this.interval?t:(t.minute(0),"hourly"==this.interval?t:(t.hours(0),"daily"==this.interval?t:(t.date(1),"monthly"==this.interval?t:(t.month(0),t))))},LogstatsDataConverter.prototype.getEndDate=function(){var t;if("undefined"!=typeof this.timeframe)t=moment(this.timeframe.to,"X").tz("GMT");else{var e=this.data[this.data.length-1];t=moment.tz({year:e.year,month:e.month-1,day:e.day,hour:e.hour,minute:e.minute},"GMT")}return t},LogstatsDataConverter.prototype.incrementDate=function(t){return"minutely"==this.interval&&t.add(1,"m"),"hourly"==this.interval&&t.add(1,"h"),"daily"==this.interval&&t.add(1,"d"),"monthly"==this.interval&&t.add(1,"M"),"yearly"==this.interval&&t.add(1,"y"),t},LogstatsDataConverter.prototype.initializeDateDate=function(t,e){"undefined"==typeof t[e.year()]&&(t[e.year()]={}),"undefined"==typeof t[e.year()][e.month()]&&(t[e.year()][e.month()]={}),"undefined"==typeof t[e.year()][e.month()][e.date()]&&(t[e.year()][e.month()][e.date()]={}),"undefined"==typeof t[e.year()][e.month()][e.date()][e.hour()]&&(t[e.year()][e.month()][e.date()][e.hour()]={}),"undefined"==typeof t[e.year()][e.month()][e.date()][e.hour()][e.minute()]&&(t[e.year()][e.month()][e.date()][e.hour()][e.minute()]={})},LogstatsDataConverter.prototype.getGroupAssoc=function(t){for(var e=0;e<this.data.length;e++){var a=this.data[e],r=a.group,o=a.year,n="undefined"!=typeof a.month?a.month:1,i="undefined"!=typeof a.day?a.day:1,s="undefined"!=typeof a.hour?a.hour:0,l="undefined"!=typeof a.minute?a.minute:0;t[r][o][n-1][i][s][l]=a.value}return t},LogstatsDataConverter.prototype.getAssoc=function(t){for(var e=0;e<this.data.length;e++){var a=this.data[e],r=a.year,o="undefined"!=typeof a.month?a.month:1,n="undefined"!=typeof a.day?a.day:1,i="undefined"!=typeof a.hour?a.hour:0,s="undefined"!=typeof a.minute?a.minute:0;t[r][o-1][n][i][s]=a.value}return t},LogstatsGraphDrawer.prototype.draw=function(t,e){if(this.logstatsData=t,this.timeframe=e,this.interval=this.determineInterval(),this.groupBySet=this.determineGroupBy(),this.graphType=this.determineBestGraphType(),this.clearGraph(),!this.validDataCount())return void this.displayErrors(["Too much datapoints to display. Please choose larger interval or smaller timeframe"]);switch(this.graphType){case GraphType.NO_DATA:this.drawNoData();break;case GraphType.ONE_VALUE:this.drawOneValue();break;case GraphType.BAR:this.drawBar();break;case GraphType.ONE_LINE:this.drawOneLine();break;case GraphType.MULITPLE_LINES:this.drawMultipleLines()}},LogstatsGraphDrawer.prototype.clearGraph=function(){$(".graph-checkboxes").html(""),$(this.selector).removeClass("graph-one-value-container")},LogstatsGraphDrawer.prototype.drawNoData=function(){this.displayErrors(["No data found by given query"])},LogstatsGraphDrawer.prototype.displayErrors=function(t){self=this,$(this.selector).html("<div class='bg-danger errors message-div'><ul class='list-unstyled'></ul></div>"),$.each(t,function(t,e){$("ul",$(self.selector)).append("<li>"+e+"</li>")})},LogstatsGraphDrawer.prototype.drawOneValue=function(){var t=this.logstatsData[0].value;$(this.selector).html("<div class='graph-one-value'>Result: "+t+"</div>"),$(this.selector).addClass("graph-one-value-container")},LogstatsGraphDrawer.prototype.drawBar=function(){var t=this.getFlotBarData();this.flot=$.plot(this.selector,t,this.getFlotBarOptions())},LogstatsGraphDrawer.prototype.drawOneLine=function(){var t=this.getFlotOneLineData();this.currentShowedData=t,this.flot=$.plot(this.selector,t,this.flotLineOptions)},LogstatsGraphDrawer.prototype.drawMultipleLines=function(){var t=this.getMultipleLineAssociativeDataWithZeros(),e=this.getFlotMultiLineData(t);this.currentShowedData=e,this.options.enableLineManipulation&&(this.showCheckboxes(),this.enableLineManipulation()),this.flot=$.plot(this.selector,e,this.flotLineOptions)},LogstatsGraphDrawer.prototype.getFlotMultiLineData=function(t){var e=this,a=[],r=0;return $.each(t,function(t,o){a.push({label:t,data:e.getFlotDateData(o),clickable:!0,hoverable:!0,shadowSize:2,color:r++})}),a},LogstatsGraphDrawer.prototype.getFlotDateData=function(t){var e=[];return $.each(t,function(t,a){$.each(a,function(a,r){$.each(r,function(r,o){$.each(o,function(o,n){$.each(n,function(n,i){var s=1e3*moment.tz({year:t,month:a,day:r,hour:o,minute:n},"GMT").unix();e.push([s,i])})})})})}),e},LogstatsGraphDrawer.prototype.getMultipleLineAssociativeDataWithZeros=function(){var t=new LogstatsDataConverter(this.logstatsData,this.interval,this.timeframe);return t.getMoreLinesAssociativeWithZeros()},LogstatsGraphDrawer.prototype.getFlotOneLineData=function(){var t=new LogstatsDataConverter(this.logstatsData,this.interval,this.timeframe),e=t.getOneLineAssociativeWithZeros();return[{data:this.getFlotDateData(e),label:"Result",clickable:!0,hoverable:!0,shadowSize:2,color:$("#data-holder").css("color")}]},LogstatsGraphDrawer.prototype.getFlotBarData=function(){var t=[];return $.each(this.logstatsData,function(e,a){t.push([e,a.value])}),[{label:"Result",data:t,clickable:!0,hoverable:!0,color:$("#data-holder").css("color")}]},LogstatsGraphDrawer.prototype.determineBestGraphType=function(){return 0==this.logstatsData.length?GraphType.NO_DATA:"undefined"!=typeof this.interval||this.groupBySet?"undefined"!=typeof this.interval&&this.groupBySet?GraphType.MULITPLE_LINES:"undefined"==typeof this.interval?GraphType.BAR:GraphType.ONE_LINE:GraphType.ONE_VALUE},LogstatsGraphDrawer.prototype.determineInterval=function(){if(0!=this.logstatsData.length){var t=this.logstatsData[0];return"undefined"!=typeof t.minute?"minutely":"undefined"!=typeof t.hour?"hourly":"undefined"!=typeof t.day?"daily":"undefined"!=typeof t.month?"monthly":"undefined"!=typeof t.year?"yearly":void 0}},LogstatsGraphDrawer.prototype.determineGroupBy=function(){if(0!=this.logstatsData.length){var t=this.logstatsData[0];return"undefined"!=typeof t.group}},LogstatsGraphDrawer.prototype.enableFlotHover=function(){var t=this;$(this.selector).bind("plothover",function(e,a,r){if(r){r.datapoint[0]>1e3?upper=t.getDateInFormat(moment(r.datapoint[0].toFixed(2),"x"))+"<br>":upper="";var o=r.datapoint[1].toFixed(2),n=r.series.label;$(".graph-tooltip").html(upper+n+" : "+o).css({top:r.pageY+5,left:r.pageX+5}).show()}else $(".graph-tooltip").hide()})},LogstatsGraphDrawer.prototype.getDateInFormat=function(t){return"yearly"==this.interval?t.tz(this.options.timezone).format("YYYY"):"monthly"==this.interval?t.tz(this.options.timezone).format("MMMM YYYY"):"daily"==this.interval?t.tz(this.options.timezone).format("MMMM Do YYYY"):"hourly"==this.interval?t.tz(this.options.timezone).format("MMMM Do YYYY, H:mm"):t.tz(this.options.timezone).format("MMMM Do YYYY, H:mm")},LogstatsGraphDrawer.prototype.enableLineManipulation=function(){var t=this;$(".graph-checkboxes input").click(function(){var e=[];$(".graph-checkboxes input:checked").each(function(){var a=$(this).attr("name");a!==!1&&t.currentShowedData[a]&&e.push(t.currentShowedData[a])}),e.length>0&&(t.flot.setData(e),t.flot.draw())})},LogstatsGraphDrawer.prototype.showCheckboxes=function(){$(".graph-checkboxes").html(""),$.each(this.currentShowedData,function(t,e){$(".graph-checkboxes").append("<input type='checkbox' name='"+t+"' checked='checked' id='id"+t+"'></input><label for='id"+t+"'>"+e.label+"</label>")})},LogstatsGraphDrawer.prototype.enableSelectionZooming=function(){var t=this;$(this.selector).bind("plotselected",function(e,a){$.each(t.flot.getXAxes(),function(t,e){var r=e.options;r.min=a.xaxis.from,r.max=a.xaxis.to}),t.flot.setupGrid(),t.flot.draw(),t.flot.clearSelection()})},LogstatsGraphDrawer.prototype.getFlotLineOptions=function(){var t={series:{lines:{show:!0},points:{show:!0}},grid:{clickable:!0,hoverable:!0,autoHighlight:!0},xaxis:{mode:"time",timezone:this.options.timezone}};return this.options.enableSelectionZooming&&(t.selection={mode:"x"}),t},LogstatsGraphDrawer.prototype.getFlotBarOptions=function(){var t=[];return $.each(this.logstatsData,function(e,a){t.push([e,a.group])}),{series:{lines:{show:!1},bars:{show:!0},points:{show:!1}},bars:{align:"center",barWidth:.5},grid:{clickable:!0,hoverable:!0,autoHighlight:!0},xaxis:{ticks:t}}},LogstatsGraphDrawer.prototype.validDataCount=function(){if(!this.timeframe||!this.interval)return!0;var t=(this.timeframe.to-this.timeframe.from)/60,e=this.getStepFromInterval(this.interval);const a=5e4;return a>t/e},LogstatsGraphDrawer.prototype.getStepFromInterval=function(t){var e=1;return"minutely"==t?e:(e*=60,"hourly"==t?e:(e*=24,"daily"==t?e:(e*=30,"monthly"==t?e:e*=12)))},LogstatsGraphDrawer.prototype.isExportable=function(){return this.graphType!=GraphType.NO_DATA};var GraphType={NO_DATA:"no data",BAR:"bar",ONE_VALUE:"one value",ONE_LINE:"one line",MULITPLE_LINES:"mulitple lines"};$(document).ready(function(){$(".dataManagement").size()>0}),$(document).ready(function(){$(".delete-project").click(function(){var t=$(this).attr("data-project-name");confirm("Do you really want to delete project: "+t+"? All records will be lost")&&$(this).parent("form").submit()})});